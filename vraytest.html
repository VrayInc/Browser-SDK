<!DOCTYPE html>
<html>
    <head>
        <title>Checkout</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta content="width=device-width, initial-scale=1" name="viewport">

        <!-- Modal -->
        <link rel="shortcut icon" href="images/Vray-logo-stack-blk.ico">  
        <link rel="stylesheet" href="jquery-ui-themes-1.12.1/themes/smoothness/jquery-ui.css" />
        <link rel="stylesheet" href="jquery-ui-themes-1.12.1/themes/humanity/theme.css" type="text/css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="js/jquery-3.2.1.js"></script>
        <script src="jquery-ui-1.12.1/jquery-ui.js"></script>

        <!-- VRAY Payment -->
        <script src="js/paymentservices.js"></script>
        <script src="js/chargeservices.js"></script>
        
        <!-- HMAC Library -->
        <script src="js/digest.js" type="text/javascript"></script>
        <script>
        function calculateHMAC(message) {
            
            ////////////////////////////////////////////////////////////////////
            // Calculate payment request MAC
            var mac = new Digest.HMAC_SHA256();        
            mac.setKey(APPSERVER.vrayHost.getMACKey());         
            mac.update(message);
            
            return mac.finalize();  
        }
        </script>
        
        <style type="text/css">
            .fieldset-auto-width {
                display: inline-block;
            }
        </style>
        
        <style type="text/css">
            .button{
                background: url(images/VRAY-Pay-Button.png) no-repeat;
                cursor:pointer;
                border: none;
                width:400px;
                height:120px;
            }
        </style>   
    </head>
	
    <body onsubmit="return false">
        <!-- Facebook Sign-in Initialization -->
        <p id="fb-root"></p>
        <script>
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.11';
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
            
            // This is called with the results from from FB.getLoginStatus().
            function statusChangeCallback(response) {

              console.log('statusChangeCallback');
              console.log(response);
              // The response object is returned with a status field that lets the
              // app know the current login status of the person.
              // Full docs on the response object can be found in the documentation
              // for FB.getLoginStatus().
              if (response.status === 'connected') {
                    // Logged into your app and Facebook.
                    testAPI();
              } else {
                   console.log('Facebook user, ' + response.name + ', is not login.');
              }
            };

            // This function is called when someone finishes with the Login
            // Button.  See the onlogin handler attached to it in the sample
            // code below.
            function checkLoginState() {
              FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
              });
            }
            
            window.fbAsyncInit = function() {
                
                FB.init({
                  appId      : '1758733777479255',
                  cookie     : true,  // enable cookies to allow the server to access the session
                  xfbml      : true,  // parse social plugins on this page
                  version    : 'v2.8' // use graph api version 2.8
                });

                // Now that we've initialized the JavaScript SDK, we call 
                // FB.getLoginStatus().  This function gets the state of the
                // person visiting this page and can return one of three states to
                // the callback you provide.  They can be:
                //
                // 1. Logged into your app ('connected')
                // 2. Logged into Facebook, but not your app ('not_authorized')
                // 3. Not logged into Facebook and can't tell if they are logged into
                //    your app or not.
                //
                // These three cases are handled in the callback function.
                FB.getLoginStatus(function(response) {
                  statusChangeCallback(response);
                });
            };

            // Here we run a very simple test of the Graph API after login is
            // successful.  See statusChangeCallback() for when this call is made.
            function testAPI() {

              console.log('Welcome!  Fetching your information.... ');

              FB.api('/me', function(response) {
                console.log('Successful login for: ' + response.name);
              });
            };
        </script>
               
        <!-- Sign-up Options -->
        <script>
        function continueWithMerchant() {  
        
            event.preventDefault();  // Stop automatic submits form 
        
            //CARDHOLDER.id = document.forms["signupForm"]["myVId"].value;
            //CARDHOLDER.phone = document.forms["signupForm"]["phoneNumber"].value;
            //CARDHOLDER.signinType = 0;
            
            var securityQID = document.forms["signupForm"]["securityQuestion"].value;
            var securityAnswer = document.forms["signupForm"]["secretAnswer"].value;
            var signupRequest = CARDHOLDER.setSecurityQA(securityQID, securityAnswer);
            var hmac = calculateHMAC(signupRequest);  
            SIGNUP.configureSecurityQRequest(hmac);

            $("#signup").dialog( "close" );
        } 
        </script>
        
        <script>
        function continueWithFB() {
            
            event.preventDefault();  // Stop automatic submits form 
            
            CARDHOLDER.id = document.forms["signupForm"]["myVId"].value;
            CARDHOLDER.phone = document.forms["signupForm"]["phoneNumber"].value;
            CARDHOLDER.signinType = 1;
                
            if (CARDHOLDER.signinAccessToken === null) 
            { 
                FB.login(function(response) 
                {
                    if (response.authResponse) 
                    {
                        if (response.status === 'connected') 
                        {
                            SIGNUP.configure3rdPartySigninRequest(1, response.authResponse.accessToken);
                             $("#signup").dialog( "close" );
                        } else 
                        {
                            window.alert("Facebook login failed.");
                        }
                        
                    } else 
                    {
                        window.alert("Facebook login cancelled.");
                    }
                }, 
                {scope: 'email,public_profile', return_scopes: true});
            } 
            else {
                FB.getLoginStatus(function(response) {
                
                    if (response.authResponse) 
                    {
                        if (response.status === 'connected') 
                        {
                            SIGNUP.configure3rdPartySigninRequest(1, response.authResponse.accessToken);
                             $("#signup").dialog( "close" );
                        } 
                        else {
                            window.alert("Facebook login failed.");
                        }
                    }
                    else {
                        window.alert("Facebook login cancelled.\n");
                    }
                });
            }
        }
        </script>
        
        <script>
        function continueWithGoogle() {
            
            event.preventDefault();  // Stop automatic submits form 
            
            CARDHOLDER.id = document.forms["signupForm"]["myVId"].value;
            CARDHOLDER.phone = document.forms["signupForm"]["phoneNumber"].value;
            CARDHOLDER.signinType = 2;
            
            window.alert("Google Sign-in is not yet supported.");
        }
        </script>
        
        <!-- Payment Request -->
        <img src="images/VRAY-logo.png" alt="HTML5 Icon" style="width:200px;height:160px;">
	    <form id="paymentInfo" name="paymentForm" action="paymentRequest" method="POST" onsubmit="return false">
            <!-- Payment Server Configuration -->
            <fieldset class="fieldset-auto-width">
                <legend style="font-family:arial"><b> Payment Server Configuration </b></legend>
                <p style="font-family:arial"><label for="serverId" >Server URL: </label>
                    <select id="serverId" >
                        <option value="https://vraystaging.azurewebsites.net">STAGING</option>
                        <option value="https://vrayserverdevapolo.azurewebsites.net">DEVELOPMENT</option>
                        <option value="https://vray.azurewebsites.net">PRODUCTION</option>
                    </select>
                </p>
                <p></p>
		        <p style="font-family:arial"><label for="merchantId">Merchant ID: </label>
                    <select id="merchantId" >
                        <option value="merchant.com.vray.vpay">VRAYInc.com</option>
                        <option value="merchant.com.vray.vpay">AsiaRoom.com</option>
                        <option value="merchant.com.vray.vpay">NeuLivenHealth.com</option>
                    </select>
            </fieldset><p></p>
            
            <!-- Checkout -->
            <fieldset class="fieldset-auto-width">
                <legend style="font-family:arial"><b> Checkout </b></legend>
                <div>
                    <p style="font-family:arial"><label for="amount">Total Amount: </label>
			<input id="amount" type="number" step="0.01" min="0" name="total"/>
                    </p>
                    <p style="font-family:arial"><label for="myVId">ID/eMail: </label>
			<input id="myVId" type="text" name="vpayId"/>
                    </p>
                    <p style="font-family:arial"><label for="phoneNumber">Mobile Phone#: </label>
			<input id="phoneNumber" type="text" name="phoneNumber" placeholder="XXXYYYZZZZ"/>
                    </p>
                    <p style="font-family:arial">
                        <label>Shipping Address: </label> <br/>                       
                        <label for="streetAddr">Street - </label>
                        <input id="streetAddr" type="text" name="streetAddr"/>    
                        <label for="city">City - </label>
                        <input id="city" type="text" name="city"/><br/><br/>
                        <label for="state">State - </label>
                        <input id="state" type="text" name="state"/>
                        <label for="zipCode">Zip Code - </label>
                        <input id="zipCode" type="text" name="zipCode"/>
                    </p>
                </div>
                <div>
                    <p style="font-family:arial; font-weight: bold">
                        <input id="pay-with-mobile-button" type="button" onclick="submitVRAYPay()" value=" " class="button" onsubmit="return false"/>
                    </p>
                </div>   
            </fieldset>
	</form>     
        
        <script>
        function submitVPay()
        {   
            
            event.preventDefault();  // Stop automatic submits form 
             
            ////////////////////////////////////////////////////////////////////
            // Application Servers Configuration:
            //   
            var paymentServerURL = document.forms["paymentForm"]["serverId"].value;
            APPSERVER.vrayHost.setDomainURL(paymentServerURL);
            
            ////////////////////////////////////////////////////////////////////
            // Merchant Server Configuration: 
            //  
            var merchantId = document.forms["paymentForm"]["merchantId"].value;
            var merchantName = document.forms["paymentForm"]["merchantId"].value; 
            MERCHANT.configure(merchantId, merchantName);

            ////////////////////////////////////////////////////////////////////
            // Cardholder Information:
            //
            var vId          = document.forms["paymentForm"]["myVId"].value; 
            var phoneNumber  = document.forms["paymentForm"]["phoneNumber"].value; 
            var streetAddr   = document.forms["paymentForm"]["streetAddr"].value;
            var city         = document.forms["paymentForm"]["city"].value;
            var state        = document.forms["paymentForm"]["state"].value;
            var zipCode      = document.forms["paymentForm"]["zipCode"].value;
            var shippingAddr = [streetAddr, city, state, zipCode];
            CARDHOLDER.configure(vId, vId, phoneNumber, shippingAddr);
            
            ////////////////////////////////////////////////////////////////////
            // Payment Request:
            //
            TRANSACTION.init();
            var amount       = document.forms["paymentForm"]["amount"].value;
            var purchaseItems = "Item#1, Item#2, Item#3, ...";
            var purchaseOrder = PAYMENT.create(amount, purchaseItems);
            var hmac = calculateHMAC(purchaseOrder);  
            PAYMENT.authorizationRequest(hmac);              
        };
        </script>
        
        <script> 
        function continueWithSecurityQ() 
        {
            
            var signupStart = '<div id="signup"><form id="signupForm" onsubmit="return false">';
            
            var vID = 
                '<p><label for="myVId">ID/eMail: </label><br>\n\
                <input id="myVId" type="text" value="' + CARDHOLDER.id +  '" /></p>';
        
            var phone = 
                '<p><label for="phoneNumber">Mobile Phone#:</label><br>\n\
                <input id="phoneNumber" type="text" value="' + CARDHOLDER.phone + '"/></p>';
                 
            var securityQA = 
                '<p><label for="securityQuestion"> Security Questions: </label><br>\n\
                <select id="securityQuestion">\n\
                <option value=1> What was the name of your elementary school? </option>\n\
                <option value=2> What was the name of your first pet? </option>\n\
                <option value=3> What is the city of your birth? </option>\n\
                <option value=4> What is the title of your favorite movie? </option>\n\
                <option value=5> What was the model of your first car? </option>\n\
                <option value=6> What street name did you grow up on? </option>\n\
                <option value=7> What city did you get married in?</option>\n\
                <option value=8> How old were you when you got your first job? </option></select></p>\n\
                <p><label for="secretAnswer">Security Answer: </label><br>\n\
                <input id="secretAnswer" type="text"/></p>';
        
            var merchantLogin = 
                '<p id="merchant-login"></p>\n\
                <p><input id="with-merchant" type="submit" value="Continue with Merchant" onclick="continueWithMerchant();"/></p>';
                
        
            var signupEnd = '</form></div>';
            
            var signupDialog =  signupStart + vID + phone + securityQA + merchantLogin + signupEnd;
           
            $(signupDialog).dialog( {
                    title : "Sign Up",
                    modal : true,
                    height : 400,
                    width : 400,
                    resizable : true,
                    autoOpen : true
                }).css("font-size", "12px");
        };
        </script>

        <script src="merchant-button.js"></script>
    </body>
</html>
